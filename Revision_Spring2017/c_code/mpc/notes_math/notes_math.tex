\documentclass[12pt]{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{calc}
\usepackage{color}
\usepackage{commath}
%\usepackage{enumitem}
%\usepackage[c]{esvect}
%\usepackage{etoolbox}
%\usepackage{float}
%\usepackage{graphicx}
\usepackage{lastpage}
%\usepackage{listings}
\usepackage{mathtools}
%\usepackage{siunitx}
%\usepackage{tikz}


% For multipage align*
\allowdisplaybreaks

\title{Notes on MPC Math in Kernel Module}
\author{Taran Lynn}
%\date{}

\begin{document}
\maketitle

\section{Model}

$l(t)$ denotes the RTT and $r(t)$ denotes the pacing rate at time $t$. Let $N$
be the current time.

\subsection{Basic Parameterized Model}

\begin{align*}
    \Delta{l}(n) &= l(n) - \hat{l}(n)\\
    \hat{l}(n) &= \sum_{i = 0}^p a_i l(n - i) + \sum_{j = 0}^q b_j r(n - j)\\
    \\
    a_i' &= a_i + \frac{l(N - i) \Delta{l}}{\sum l^2 + \sum r^2}\\
    b_i' &= b_i + \frac{r(N - i) \Delta{l}}{\sum l^2 + \sum r^2}\\
    \\
    \sum_{i = 0}^p a_i' l(N - i) + \sum_{j = 0}^q b_j' r(N - j) &=
    \sum_{i = 0}^p a_i l(N - i) + \sum_{j = 0}^q b_j r(N - j)\\
    &\qquad + \sum_{i = 0}^p \frac{l(N - i)^2 \Delta{l}}{\sum l^2 + \sum r^2}
    + \sum_{j = 0}^q \frac{r(N - j)^2 \Delta{l}}{\sum l^2 + \sum r^2}\\
    %
    &= \sum_{i = 0}^p a_i l(N - i) + \sum_{j = 0}^q b_j r(N - j)
    + \frac{(\sum l^2 + \sum r^2) \Delta{l}}{\sum l^2 + \sum r^2}\\
    %
    &= \hat{l}(N) + \Delta{l}(N)\\
    &= l(N)
\end{align*}

\pagebreak

\subsection{Square Root Parameterized Model}

\begin{align*}
    \Delta{l}(n) &= l(n) - \hat{l}(n)\\
    \hat{l}(n) &= \sum_{i = 0}^p a_i \sqrt{l(n - i)} + \sum_{j = 0}^q b_j \sqrt{r(n - j)}\\
    \\
    a_i' &= a_i + \frac{\sqrt{l(N - i)} \Delta{l}}{\sum l + \sum r}\\
    b_i' &= b_i + \frac{\sqrt{r(N - i)} \Delta{l}}{\sum l + \sum r}\\
    \\
    \sum_{i = 0}^p a_i' \sqrt{l(N - i)} + \sum_{j = 0}^q b_j' \sqrt{r(N - j)} &=
    \sum_{i = 0}^p a_i \sqrt{l(N - i)} + \sum_{j = 0}^q b_j \sqrt{r(N - j)}\\
    &\qquad + \sum_{i = 0}^p \frac{l(N - i) \Delta{l}}{\sum l + \sum r}
    + \sum_{j = 0}^q \frac{r(N - j) \Delta{l}}{\sum l + \sum r}\\
    %
    &= \sum_{i = 0}^p a_i \sqrt{l(N - i)} + \sum_{j = 0}^q b_j \sqrt{r(N - j)}
    + \frac{(\sum l + \sum r) \Delta{l}}{\sum l + \sum r}\\
    %
    &= \hat{l}(N) + \Delta{l}(N)\\
    &= l
\end{align*}

Considering the control $r = r(N)$, we want to minimize

\begin{align*}
    \frac{(1 - \alpha) \hat{l}(N)}{\mu_l(N)} - \frac{\alpha r}{\mu_r(N - 1)} &=
    \frac{1 - \alpha}{\mu_l(N)} \del{\sum_{i = 0}^p a_i \sqrt{l(N - i)} + \sum_{j = 0}^q b_j \sqrt{r(N - j)}}
    - \frac{\alpha r}{\mu_r(N - 1)}\\
    &= \frac{(1 - \alpha) b_0 \sqrt{r(N)}}{\mu_l(N)} - \frac{\alpha r}{\mu_r(N - 1)}\\
    &\qquad + \frac{1 - \alpha}{\mu_l(N)} \del{\sum_{i = 0}^p a_i \sqrt{l(N - i)} + \sum_{j = 1}^q b_j \sqrt{r(N - j)}}\\
    &= \frac{(1 - \alpha) b_0 \sqrt{r(N)}}{\mu_l(N)} - \frac{\alpha r}{\mu_r(N - 1)} +
    \frac{(1 - \alpha) \sbr{\hat{l}}_{r(N) = 0}}{\mu_l(N)}\\
    \\
    \dod{}{r} (\hat{l}(N) - r) &= 0\\
    \frac{(1 - \alpha) b_0}{2 \mu_l(N) \sqrt{r}} - \frac{\alpha}{\mu_r(N - 1)} &= 0\\
    r &= \del{\frac{(1 - \alpha) b_0 \mu_r(N - 1)}{2 \alpha \mu_l(N)}}^2
\end{align*}

$\alpha$ is a parameter that weighs which parameter we want to minimize more.
$\alpha = 0$ only weighs the pacing rate ($r \to \infty$), and $\alpha = 1$
only weighs RTT ($r = 0$).

\pagebreak

\subsection{Step Model}

\begin{align*}
    y_0 &= \bar{l}\\
    \Delta l(i) &= l(i) - l(i - 1)\\
    \Delta r(i) &= r(i) - r(i - 1)\\
    \\
    \delta{l}(N) &= l(N) - \hat{l}(N)\\
    \hat{l}(N) &= y_0 + \sum_{i = 0}^p a_i \Delta l(N - i) + \sum_{j = 0}^q b_j \Delta r(N - j)\\
    \\
    a_i' &= a_i + \frac{\Delta l(N - i) \delta{l}(N)}{\sum (\Delta l)^2 + \sum (\Delta r)^2}\\
    b_i' &= b_i + \frac{\Delta r(N - i) \delta{l}(N)}{\sum (\Delta l)^2 + \sum (\Delta r)^2}\\
    \\
    y_0 +
    \sum_{i = 1}^p a_i' \Delta l(N - i) + \sum_{j = 1}^q b_j' \Delta r(N - j)
    &= y_0 +
    \sum_{i = 1}^p a_i \Delta l(i) + \sum_{j = 1}^q b_j \Delta r(j)\\
    &\qquad + \sum_{i = 1}^p \frac{(\Delta l(N - i))^2 \delta{l}(N)}{\sum (\Delta l)^2 + \sum (\Delta r)^2}
    + \sum_{j = 1}^q \frac{(\Delta r(N - j))^2 \delta{l}(N)}{\sum (\Delta l)^2 + \sum (\Delta r)^2}\\
    %
    &= y_0 + (\hat{l}(N) - y_0)
    + \frac{(\sum (\Delta l)^2 + \sum (\Delta r)^2) \delta{l}(N)}{\sum (\Delta l)^2 + \sum (\Delta r)^2}\\
    %
    &= \hat{l}(N) + \delta{l}(N)\\
    &= l(N)
\end{align*}

\subsubsection{Rate Prediction}

Choose $r(N)$ such that $m(r(N))$ is minimized.
\begin{align*}
    m(r(N)) &=\frac{\sbr{\hat{l}(N)}_{\Delta r(N) = r(N) - r(N - 1)}}{\mu_l(N)} - \frac{r(N)}{\mu_r(N - 1)}\\
    &= \frac{b_0 \Delta r(N)}{\mu_l(N)} - \frac{r(N)}{\mu_r(N - 1)}
    + \sbr{\hat{l}(N)}_{\Delta r(N) = 0}\\
    &= \frac{b_0 (r(N) - r(N - 1))}{\mu_l(N)} - \frac{r(N)}{\mu_r(N - 1)}
    + \sbr{\hat{l}(N)}_{\Delta r(N) = 0}\\
    \\
    \dod{}{r(N)} m(r(N)) &= 0\\
    \frac{b_0}{\mu_l(N)} - \frac{1}{\mu_r(N - 1)} &= 0\\
    b_0 &= \frac{\mu_l(N)}{\mu_r(N - 1)}\\
\end{align*}

We want to move $b_0$ towards this value, so consider $b_0'$.

\begin{align*}
    b_0' &= \frac{\mu_l(N)}{\mu_r(N - 1)}\\
    b_0 + \frac{\Delta r(N) \delta l(N)}{\sum (\Delta l)^2 + \sum (\Delta r)^2} &= \frac{\mu_l(N)}{\mu_r(N - 1)}\\
    b_0 + \frac{\Delta r(N) \delta l(N)}{\Delta r(N)^2 + \sum (\Delta l)^2
    + \sum _{j = 1}^N (\Delta r(N - j))^2} &= \frac{\mu_l(N)}{\mu_r(N - 1)}\\
\end{align*}

\end{document}

